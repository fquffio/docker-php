SHELL := /bin/bash
.PHONY: pull build-nopull build test

PARENT_IMAGE := chialab/php
IMAGE := chialab/php-dev
VERSION ?= latest
PHP_VERSION := $(firstword $(subst -, ,$(VERSION)))

# Extensions.
EXTENSIONS := \
	bcmath \
	bz2 \
	calendar \
	iconv \
	intl \
	gd \
	ldap \
	mbstring \
	memcached \
	mysqli \
	pdo_mysql \
	pdo_pgsql \
	pgsql \
	redis \
	soap \
	Xdebug \
	zip
ifeq (,$(findstring $(PHP_VERSION), 7.2 latest))
	# Add more extensions to PHP < 7.2.
	EXTENSIONS += mcrypt
endif
ifeq (,$(findstring $(PHP_VERSION), 7.0 7.1 7.2 latest))
	# Add more extensions to 5.x series images.
	EXTENSIONS += mysql
endif
ifneq (,$(findstring $(PHP_VERSION), 5.5 5.6 7.0 7.1 7.2 latest))
	# Add OPCache check to PHP version with Zend OPCache.
	EXTENSIONS += OPcache
endif

build:
	@echo " =====> Building $(IMAGE):$(VERSION)..."
	@docker build --quiet \
		--build-arg VERSION=$(VERSION) \
		--label org.label-schema.build-date=$(shell date -u "+%Y-%m-%dT%H:%M:%SZ") \
		--label org.label-schema.vcs-ref=$(shell git rev-parse HEAD) \
		--tag $(IMAGE):$(VERSION) \
		.

test:
	@echo -e "=====> Testing loaded extensions... \c"
	@if [[ -z `docker images $(IMAGE) | grep "\s$(VERSION)\s"` ]]; then \
		echo 'FAIL [Missing image!!!]'; \
		exit 1; \
	fi
	@modules=`docker run --rm $(IMAGE):$(VERSION) php -m`; \
	for ext in $(EXTENSIONS); do \
		if [[ "$${modules}" != *"$${ext}"* ]]; then \
			echo "FAIL [$${ext}]"; \
			exit 1; \
		fi \
	done
	@if [[ "$(VERSION)" == *'-apache' ]]; then \
		apache=`docker run --rm $(IMAGE):$(VERSION) apache2ctl -M 2> /dev/null`; \
		if [[ "$${apache}" != *'rewrite_module'* ]]; then \
			echo 'FAIL [mod_rewrite]'; \
			exit 1; \
		fi \
	fi
	@if [[ -z `docker run --rm $(IMAGE):$(VERSION) composer --version 2> /dev/null | grep '^Composer version [0-9][0-9]*\.[0-9][0-9]*'` ]]; then \
		echo 'FAIL [Composer]'; \
		exit 1; \
	fi
	@echo 'OK'
